<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Owner Dashboard</h1>
        <hr>

        <!-- Pending Authorization Section -->
        <h4>Pending Authorization</h4>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Employee Name</th>
                    <th>Store Address</th>
                    <th>Phone Number</th>
                    <th>Email</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="pendingTableBody">
                <!-- Dynamically populated -->
                <tr id="emptyRow">
                    <td colspan="7" class="text-center text-muted">No pending authorization requests at the moment.</td>
                </tr>
            </tbody>
        </table>

         <hr>

        <!-- Stock Warnings Section -->
        <div id="stockWarnings" class="alert alert-warning d-none">
            <h4>Stock Warnings</h4>
            <ul id="warningList"></ul>
            <button class="btn btn-danger mt-3" onclick="downloadStockReport()">üìÑ Download PDF</button>
        </div>

         <hr>

        <!-- Checklist Section -->
        <div class="card p-3 mb-5">
            <h3>Owner Inventory Management</h3>
            <form id="ownerInventoryForm">
                <div class="mb-3">
                    <label for="ownerCategoryDropdown" class="form-label">Select Category</label>
                    <select class="form-control" id="ownerCategoryDropdown" required>
                        <option value="" disabled selected>-- Select Category --</option>
                    </select>
                </div>
            </form>
        </div>

        <!-- Item List Section -->
        <div id="itemListSection" class="mt-5 d-none">
            <h3>Items in Selected Category</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Current Stock</th>
                        <th>Max Stock Level</th>
                        <th>Reorder Level</th>
                        <th>Supplier</th>
                        <th>Picture</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="itemListTableBody">
                    <!-- Dynamically populated -->
                </tbody>
            </table>
        </div>

        <hr>

        <!-- Navigation -->
        <div class="list-group mb-3">
            <button class="list-group-item list-group-item-action" onclick="showAddItemForm()">Add Item</button>
            <button class="list-group-item list-group-item-action" onclick="showEditCategoryForm()">Edit Category</button>
            <button class="list-group-item list-group-item-action" onclick="showAccountManagement()">Manage Accounts</button>
            <button class="list-group-item list-group-item-action" onclick="showSettingAccountForm()">Setting Account</button>
        </div>

        <!-- Add Item Form -->
        <div id="addItemForm" class="card p-3 d-none">
            <h4>Add New Item</h4>
            <form id="addItemFormContent" method="POST" action="/owner_dashboard" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="name" class="form-label">Item Name</label>
                    <input type="text" class="form-control" id="name" name="name" required>
                </div>
                <div class="mb-3">
                    <label for="category" class="form-label">Category</label>
                    <select class="form-control" id="category" name="category" required></select>
                </div>
                <div class="mb-3">
                    <label for="max_stock_level" class="form-label">Max Stock Level</label>
                    <input type="number" class="form-control" id="max_stock_level" name="max_stock_level" min="0" required>
                </div>
                <div class="mb-3">
                    <label for="in_stock_level" class="form-label">In-Stock Level</label>
                    <input type="number" class="form-control" id="in_stock_level" name="in_stock_level" min="0" required>
                </div>
                <div class="mb-3">
                    <label for="reorder_level" class="form-label">Reorder Level</label>
                    <input type="number" class="form-control" id="reorder_level" name="reorder_level" min="0" required>
                </div>
                <div class="mb-3">
                    <label for="supplier" class="form-label">Supplier</label>
                    <input type="text" class="form-control" id="supplier" name="supplier" required>
                </div>
                <div class="mb-3">
                    <label for="picture" class="form-label">Item Picture</label>
                    <input type="file" class="form-control" id="picture" name="picture" accept="image/*">
                </div>
                <button type="submit" class="btn btn-success w-100">Save Item</button>
            </form>
        </div>

        <!-- Edit Categories -->
        <div id="editCategoryForm" class="card p-3 d-none">
            <h4>Edit Categories</h4>
            <textarea class="form-control mb-3" id="categoriesList" rows="5"></textarea>
            <button class="btn btn-primary w-100" onclick="saveCategories()">Save Categories</button>
        </div>

        <!-- Account Management Section -->
        <div id="accountManagementSection" class="card p-3 d-none">
            <h4>Account Management</h4>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Employee Name</th>
                        <th>Store Address</th>
                        <th>Phone Number</th>
                        <th>Email</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="accountTableBody">
                    <!-- Dynamically populated -->
                </tbody>
            </table>
        </div>

        <!-- Account Edit Modal -->
        <div class="modal fade" id="editAccountModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Account</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editAccountForm">
                            <!-- ÈöêËóèË¥¶Êà∑ ID -->
                            <input type="hidden" id="editAccountID">

                            <div class="mb-3">
                                <label for="editUsername" class="form-label">Username</label>
                                <input type="text" class="form-control" id="editUsername" required>
                            </div>
                            <div class="mb-3">
                                <label for="editRole" class="form-label">Role</label>
                                <select class="form-select" id="editRole" required>
                                    <option value="owner">Owner</option>
                                    <option value="employee">Employee</option>
                                    <option value="manager">Manager</option>
                                    <option value="server">Server</option>
                                    <option value="line_cook">Line Cook</option>
                                    <option value="prep_cook">Prep Cook</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="editEmployeeName" class="form-label">Employee Name</label>
                                <input type="text" class="form-control" id="editEmployeeName" required>
                            </div>
                            <div class="mb-3">
                                <label for="editStoreAddress" class="form-label">Store Address</label>
                                <select class="form-select" id="editStoreAddress" name="store_address" required>

                                    <option value="Kusan Uyghur Cuisine, 1516 N 4th Street, San Jose, CA 95112">
                                        Kusan Uyghur Cuisine, 1516 N 4th Street, San Jose, CA 95112
                                    </option>
                                    <option value="Kusan Bazaar, 510 Barber Ln, Milpitas, CA 95035">
                                        Kusan Bazaar, 510 Barber Ln, Milpitas, CA 95035
                                    </option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="editPhoneNumber" class="form-label">Phone Number</label>
                                <input type="text" class="form-control" id="editPhoneNumber">
                            </div>
                            <div class="mb-3">
                                <label for="editEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmail">
                            </div>


                            <div class="mb-3">
                                <label for="editPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="editPassword" required>
                            </div>
                            <button type="submit" class="btn btn-success w-100">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Setting Account Form -->
        <div id="settingAccountForm" class="card p-3 d-none">
            <h4>Setting Account</h4>
            <form id="createAccountForm">
                <div class="mb-3">
                    <label for="createUsername" class="form-label">Username</label>
                    <input type="text" class="form-control" id="createUsername" placeholder="Enter username" required>
                </div>
                <div class="mb-3">
                    <label for="createRole" class="form-label">Role</label>
                    <select class="form-select" id="createRole" name="role" required>
                        <option value="" disabled selected>Select a role</option>
                        <option value="employee">Employee</option>
                        <option value="server">Server</option>
                        <option value="line_cook">Line Cook</option>
                        <option value="prep_cook">Prep Cook</option>
                        <option value="owner">Owner</option>
                        <option value="manager">Manager</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="createEmployeeName" class="form-label">Employee Name</label>
                    <input type="text" class="form-control" id="createEmployeeName" placeholder="Enter employee name" required>
                </div>
                <div class="mb-3">
                    <label for="createStoreAddress" class="form-label">Store Address</label>
                    <select class="form-select" id="createStoreAddress" name="store_address" required>
                        <option value="" disabled selected>Select a store</option>
                        <option value="Kusan Uyghur Cuisine, 1516 N 4th Street, San Jose, CA 95112">
                            Kusan Uyghur Cuisine, 1516 N 4th Street, San Jose, CA 95112
                        </option>
                        <option value="Kusan Bazaar, 510 Barber Ln, Milpitas, CA 95035">
                            Kusan Bazaar, 510 Barber Ln, Milpitas, CA 95035
                        </option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="createPhoneNumber" class="form-label">Phone Number</label>
                    <input type="text" class="form-control" id="createPhoneNumber" placeholder="Enter phone number"
                           required>
                </div>
                <div class="mb-3">
                    <label for="createEmail" class="form-label">Email</label>
                    <input type="email" class="form-control" id="createEmail" placeholder="Enter email" required>
                </div>

                <div class="mb-3">
                    <label for="createPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="createPassword" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-success w-100">Create Account</button>
            </form>
        </div>

        <!-- Edit Item Modal -->
        <div class="modal fade" id="editItemModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Item</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editItemForm">
                            <input type="hidden" id="editItemID">
                            <div class="mb-3">
                                <label for="editItemCategoryDropdown" class="form-label">Category</label>
                                <select class="form-control" id="editItemCategoryDropdown" required></select>
                            </div>
                            <div class="mb-3">
                                <label for="editMaxStock" class="form-label">Max Stock Level</label>
                                <input type="number" class="form-control" id="editMaxStock" min="0" required>
                            </div>
                            <div class="mb-3">
                                <label for="editInStock" class="form-label">In-Stock Level</label>
                                <input type="number" class="form-control" id="editInStock" min="0" required>
                            </div>
                            <div class="mb-3">
                                <label for="editReorderLevel" class="form-label">Reorder Level</label>
                                <input type="number" class="form-control" id="editReorderLevel" min="0" required>
                            </div>
                            <button type="submit" class="btn btn-success w-100">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="card p-3 mt-5">
            <h3>Stock Update History</h3>
            <div>
                <ul id="updateHistoryList" class="list-group">
                    <!-- Dynamically populated -->
                </ul>
            </div>
        </div>


        <!-- Exit -->
        <div class="text-center mt-5">
            <a href="/" class="btn btn-danger">Exit</a>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Fetch pending authorization accounts

        function formatRole(role) {
            const roleMapping = {
                owner: 'Owner',
                employee: 'Employee',
                manager: 'Manager',
                server: 'Server',
                line_cook: 'Line Cook',
                prep_cook: 'Prep Cook'
            };
            return roleMapping[role] || role;
        }

        async function fetchPendingAccounts() {
            const response = await fetch('/pending_accounts');
            const accounts = await response.json();
            const tableBody = document.getElementById('pendingTableBody');
            tableBody.innerHTML = '';

                if (accounts.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">No pending authorization requests at the moment.</td>
                        </tr>
                    `;
                    return;
                }

                accounts.forEach(account => {
                    const row = `
                                <tr>
                                    <td>${account.username}</td>
                                    <td>${formatRole(account.role)}</td>
                                    <td>${account.employee_name || 'N/A'}</td>
                                    <td>${account.store_address || 'N/A'}</td>
                                    <td>${account.phone_number || 'N/A'}</td>
                                    <td>${account.email || 'N/A'}</td>
                                    <td>
                                        <button class="btn btn-success btn-sm" onclick="authorizeAccount(${account.id})">Authorize</button>
                                        <button class="btn btn-danger btn-sm" onclick="rejectAccount(${account.id})">Reject</button>
                                    </td>
                                </tr>
                            `;
                    tableBody.insertAdjacentHTML('beforeend', row);
            });

        }

        // È°µÈù¢Âä†ËΩΩÊó∂Ë∞ÉÁî® fetchPendingAccounts
        document.addEventListener('DOMContentLoaded', () => {
            fetchPendingAccounts();
        });

        // Authorize account
        async function authorizeAccount(accountId) {
            const response = await fetch(`/authorize_account/${accountId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            if (response.ok) {
                alert('Account authorized successfully!');
                fetchPendingAccounts();
                fetchAccounts();// Refresh the table
            } else {
                alert('Failed to authorize account.');
            }
        }

        // ÊãíÁªùË¥¶Êà∑ÊéàÊùÉ
        async function rejectAccount(accountId) {
            if (confirm('Are you sure you want to reject this account?')) {
                const response = await fetch(`/reject_account/${accountId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                if (response.ok) {
                    alert('Account rejected successfully!');
                    fetchPendingAccounts(); // Âà∑Êñ∞ÂæÖÊéàÊùÉË¥¶Êà∑ÂàóË°®
                } else {
                    alert('Failed to reject account.');
                }
            }
        }


        // Fetch items and populate the table
        async function fetchItems() {
            try {
                const response = await fetch('/items');
                const items = await response.json();

                const itemTableBody = document.getElementById('itemTableBody');
                if (itemTableBody) {
                    itemTableBody.innerHTML = ''; // Clear previous rows
                    items.forEach(item => {
                        const row = `
                            <tr>
                                <td>${item.id}</td>
                                <td>${item.name}</td>
                                <td>${item.category}</td>
                                <td>${item.in_stock_level}</td>
                            </tr>
                        `;
                        itemTableBody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    console.error('Table body not found!');
                }
            } catch (error) {
                console.error('Failed to fetch items:', error);
            }
        }

        // Fetch accounts for Account Management
        async function fetchAccounts() {
            const response = await fetch('/accounts');
            const data = await response.json();

            const authorizedAccounts = data.authorized_accounts;
            const pendingAccounts = data.pending_accounts;

            // Populate Account Management Table
            const accountTableBody = document.getElementById('accountTableBody');
            accountTableBody.innerHTML = '';
            authorizedAccounts.forEach(account => {
                const row = `
                        <tr>
                            <td>${account.username}</td>
                            <td>${formatRole(account.role)}</td>
                            <td>${account.employee_name}</td>
                            <td>${account.store_address}</td>
                            <td>${account.phone_number || 'N/A'}</td> <!-- Ê∑ªÂä† Phone Number -->
                            <td>${account.email || 'N/A'}</td> <!-- Ê∑ªÂä† Email -->
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteAccount(${account.id})">Delete</button>
                                <button class="btn btn-warning btn-sm" onclick="resetAccount(${account.id}, '${account.username}', '${account.role}', '${account.employee_name}', '${account.store_address}', '${account.phone_number}', '${account.email}')">Reset</button>
                            </td>
                        </tr>
                    `;
                accountTableBody.insertAdjacentHTML('beforeend', row);
            });

            // Populate Pending Authorization Table
            const pendingTableBody = document.getElementById('pendingTableBody');
            pendingTableBody.innerHTML = '';
            pendingAccounts.forEach(account => {
                const row = `
                            <tr>
                                <td>${account.username}</td>
                                <td>${account.role || 'N/A'}</td>
                                <td>${account.employee_name || 'N/A'}</td>
                                <td>${account.store_address || 'N/A'}</td>
                                <td>${account.phone_number || 'N/A'}</td> <!-- Ê∑ªÂä† phone_number Âàó -->
                                <td>${account.email || 'N/A'}</td> <!-- Ê∑ªÂä† email Âàó -->
                                <td>
                                    <button class="btn btn-success btn-sm" onclick="authorizeAccount(${account.id})">Authorize</button>
                                    <button class="btn btn-danger btn-sm" onclick="rejectAccount(${account.id})">Reject</button>
                                </td>
                            </tr>
                        `;
                pendingTableBody.insertAdjacentHTML('beforeend', row);
            });

        }

        function resetAccount(accountId, username, role, employeeName, storeAddress, phoneNumber, email) {
            // Â∞ÜÂèÇÊï∞Â°´ÂÖÖÂà∞Ê®°ÊÄÅÊ°Ü‰∏≠
            document.getElementById('editAccountID').value = accountId;
            document.getElementById('editUsername').value = username;
            document.getElementById('editRole').value = role;
            document.getElementById('editEmployeeName').value = employeeName;
            const editStoreAddressDropdown = document.getElementById('editStoreAddress');
            Array.from(editStoreAddressDropdown.options).forEach(option => {
                if (option.value === storeAddress) {
                    option.selected = true;
                }
            });
            document.getElementById('editPhoneNumber').value = phoneNumber || ''; // Â°´ÂÖÖÊâãÊú∫Âè∑
            document.getElementById('editEmail').value = email || ''; // Â°´ÂÖÖÈÇÆÁÆ±
            document.getElementById('editPassword').value = ''; // Ê∏ÖÁ©∫ÂØÜÁ†ÅÂ≠óÊÆµ

            // ÊâìÂºÄÊ®°ÊÄÅÊ°Ü
            const editModal = new bootstrap.Modal(document.getElementById('editAccountModal'));
            editModal.show();
        }

        // Open the Edit Modal
        function openEditAccountModal(id, username, role, employeeName, storeAddress, phoneNumber, email) {
            // Â∞ÜÂèÇÊï∞Â°´ÂÖÖÂà∞Ë°®ÂçïÂ≠óÊÆµ
            document.getElementById('editUsername').value = username;
            document.getElementById('editRole').value = role;
            document.getElementById('editEmployeeName').value = employeeName;
            document.getElementById('editStoreAddress').value = storeAddress;
            document.getElementById('editPhoneNumber').value = phoneNumber; // Â°´ÂÖÖÊâãÊú∫Âè∑
            document.getElementById('editEmail').value = email; // Â°´ÂÖÖÈÇÆÁÆ±
            document.getElementById('editPassword').value = ''; // Ê∏ÖÁ©∫ÂØÜÁ†ÅÂ≠óÊÆµ

        // ÊòæÁ§∫ÁºñËæëÊ®°ÊÄÅÊ°Ü
        const editModal = new bootstrap.Modal(document.getElementById('editAccountModal'));
        editModal.show();
    }

        // Handle Edit Account Form Submission
        document.getElementById('editAccountForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editAccountID').value; // ÈöêËóèÂ≠óÊÆµÂ≠òÂÇ®Ë¥¶Êà∑ ID
            const updatedData = {
                username: document.getElementById('editUsername').value,
                role: document.getElementById('editRole').value,
                employee_name: document.getElementById('editEmployeeName').value,
                store_address: document.getElementById('editStoreAddress').value,
                phone_number: document.getElementById('editPhoneNumber').value, // Ê∑ªÂä†ÊâãÊú∫Âè∑
                email: document.getElementById('editEmail').value, // Ê∑ªÂä†ÈÇÆÁÆ±
                password: document.getElementById('editPassword').value,
            };

            try {
                const response = await fetch(`/update_account/${id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updatedData),
                });

                if (response.ok) {
                    alert('Account updated successfully!');
                    fetchAccounts(); // Âà∑Êñ∞Ë°®Ê†ºÊï∞ÊçÆ
                } else {
                    const errorData = await response.json();
                    alert('Error: ' + errorData.message);
                }
            } catch (error) {
                alert('An error occurred while updating the account.');
            }

            const editModal = bootstrap.Modal.getInstance(document.getElementById('editAccountModal'));
            editModal.hide();
        });


        // Frontend: Sending correct user ID for deletion
        async function deleteAccount(accountId) {
            if (confirm('Are you sure you want to delete this account?')) {
                const response = await fetch('/accounts', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: accountId}),
                });

                if (response.ok) {
                    alert('Account deleted successfully!');
                    fetchAccounts();
                    fetchPendingAccounts();
                } else {
                    const errorMessage = await response.json();
                    alert(`Failed to delete account: ${errorMessage.message}`);
                }
            }
        }

            // Open Edit Item Modal
            async function openEditModal(item) {
                const response = await fetch('/categories');
                const categories = await response.json();
                const categoryDropdown = document.getElementById('editItemCategoryDropdown');

                // Clear and populate the category dropdown
                categoryDropdown.innerHTML = '<option value="">-- Select Category --</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryDropdown.appendChild(option);
                });

                // Populate the form fields with the item's data
                document.getElementById('editItemID').value = item.id;
                document.getElementById('editItemCategoryDropdown').value = item.category;
                document.getElementById('editMaxStock').value = item.max_stock_level;
                document.getElementById('editInStock').value = item.in_stock_level;
                document.getElementById('editReorderLevel').value = item.reorder_level;

                // Show the modal
                const editItemModal = new bootstrap.Modal(document.getElementById('editItemModal'));
                editItemModal.show();
            }


            // Submit Edit Item Form
            document.getElementById('editItemForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const itemId = document.getElementById('editItemID').value;
                const updatedData = {
                    category: document.getElementById('editItemCategoryDropdown').value,
                    max_stock_level: parseInt(document.getElementById('editMaxStock').value),
                    in_stock_level: parseInt(document.getElementById('editInStock').value),
                    reorder_level: parseInt(document.getElementById('editReorderLevel').value),
                };

                try {
                    const response = await fetch(`/update_item/${itemId}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(updatedData),
                    });

                    const result = await response.json();
                    if (response.ok) {
                        alert(result.message);

                        // **1. Á´ãÂç≥Êõ¥Êñ∞ÂïÜÂìÅÂàóË°®**
                        fetchItemsForOwnerCategory(document.getElementById('ownerCategoryDropdown').value);

                        // **2. Á´ãÂç≥Âà∑Êñ∞ Stock Warnings**
                        fetchStockWarnings();
                    } else {
                        alert(`Error: ${result.message}`);
                    }

                    // **ÈöêËóèÁºñËæëÂºπÁ™ó**
                    const editItemModal = bootstrap.Modal.getInstance(document.getElementById('editItemModal'));
                    editItemModal.hide();
                } catch (error) {
                    alert("An error occurred while updating the item.");
                    console.error(error);
                }
            });


        // Delete Item
            async function deleteItem(itemId) {
                if (confirm('Are you sure you want to delete this item?')) {
                    const response = await fetch(`/delete_item/${itemId}`, { method: 'POST' });

                    if (response.ok) {
                        alert('Item deleted successfully!');
                        fetchItemsForOwnerCategory(document.getElementById('ownerCategoryDropdown').value); // Refresh the item list
                    } else {
                        alert('Failed to delete item.');
                    }
                }
            }

            // Event listener for category dropdown change
            document.getElementById('ownerCategoryDropdown').addEventListener('change', function () {
                const selectedCategory = this.value;
                fetchItemsForOwnerCategory(selectedCategory);
            });

            // Initialize dropdown and hide table on page load
            document.addEventListener('DOMContentLoaded', () => {
                fetchCategories();
                fetchItemsForOwnerCategory(document.getElementById('ownerCategoryDropdown').value);
            });

        // Save categories
        async function saveCategories() {
            const categories = document.getElementById('categoriesList').value
                .split('\n')
                .map(c => c.trim())
                .filter(c => c);

            const response = await fetch('/categories', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ categories }),
            });

            if (response.ok) {
                alert('Categories updated successfully!');
                fetchCategories();
                showAddItemForm();
            } else {
                alert('Failed to save categories.');
            }
        }

        // Fetch categories and populate dropdowns
            async function fetchCategories() {
                const response = await fetch('/categories');
                const categories = await response.json();

                // Populate the owner category dropdown
                const ownerCategoryDropdown = document.getElementById('ownerCategoryDropdown');
                ownerCategoryDropdown.innerHTML = '<option value="">-- Select Category --</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    ownerCategoryDropdown.appendChild(option);
                });

                // Populate the add item category dropdown
                const addItemCategoryDropdown = document.getElementById('category');
                addItemCategoryDropdown.innerHTML = '<option value="">-- Select Category --</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    addItemCategoryDropdown.appendChild(option);
                });

                // Populate the edit item category dropdown
                const editItemCategoryDropdown = document.getElementById('editItemCategoryDropdown');
                editItemCategoryDropdown.innerHTML = '<option value="">-- Select Category --</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    editItemCategoryDropdown.appendChild(option);
                });

                // Update the categories list in the edit categories form
                document.getElementById('categoriesList').value = categories.join('\n');
            }

        // Fetch items by category for the checklist
        async function fetchItemsByCategory(category) {
            const response = await fetch('/items');
            const items = await response.json();
            const filteredItems = items.filter(item => item.category === category);

            const itemDropdown = document.getElementById('itemDropdown');
            itemDropdown.innerHTML = '<option value="">-- Select Item --</option>';
            filteredItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} (Current Stock: ${item.in_stock_level})`;
                itemDropdown.appendChild(option);
            });
        }

            // Fetch items for the selected category and populate the Item List Section
            async function fetchItemsForOwnerCategory(category) {
                if (!category) {
                    document.getElementById('itemListSection').classList.add('d-none');
                    return;
                }

                const response = await fetch('/items');
                const items = await response.json();
                console.log("Fetched items:", items); // Debug log

                const filteredItems = items.filter(item => item.category === category);
                console.log("Filtered items:", filteredItems); // Debug log

                const tableBody = document.getElementById('itemListTableBody');
                tableBody.innerHTML = ''; // Clear previous rows

                if (filteredItems.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">No items in this category.</td></tr>`;
                } else {
                    filteredItems.forEach(item => {
                        const row = `
                            <tr>
                                <td>${item.id}</td>
                                <td>${item.name}</td>
                                <td>${item.category}</td>
                                <td>${item.in_stock_level}</td>
                                <td>${item.max_stock_level}</td>
                                <td>${item.reorder_level}</td>
                                <td>${item.supplier || 'N/A'}</td>
                                <td>
                                    ${item.picture ? `<img src="${item.picture}" alt="${item.name}" style="width: 50px; height: 50px;">` : 'No Picture'}
                                </td>
                                <td>
                                    <button class="btn btn-primary btn-sm edit-item-btn"
                                            data-item-id="${item.id}"
                                            data-item-name="${item.name}"
                                            data-item-category="${item.category}"
                                            data-item-max-stock="${item.max_stock_level}"
                                            data-item-in-stock="${item.in_stock_level}"
                                            data-item-reorder-level="${item.reorder_level}">
                                        Edit Item
                                    </button>
                                    <button class="btn btn-danger btn-sm delete-item-btn" data-item-id="${item.id}">Delete</button>
                                </td>
                            </tr>
                        `;
                        tableBody.insertAdjacentHTML('beforeend', row);
                    });
                }

                // Show the Item List Section
                document.getElementById('itemListSection').classList.remove('d-none');
            }


            // Event delegation for Edit and Delete buttons
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('edit-item-btn')) {
                    const itemId = e.target.getAttribute('data-item-id');
                    const item = {
                        id: itemId,
                        name: e.target.getAttribute('data-item-name'),
                        category: e.target.getAttribute('data-item-category'),
                        max_stock_level: e.target.getAttribute('data-item-max-stock'),
                        in_stock_level: e.target.getAttribute('data-item-in-stock'),
                        reorder_level: e.target.getAttribute('data-item-reorder-level'),
                    };
                    openEditModal(item);
                }

                if (e.target.classList.contains('delete-item-btn')) {
                    const itemId = e.target.getAttribute('data-item-id');
                    deleteItem(itemId);
                }
            });


        // Handle Setting Account Form Submission
        document.getElementById('createAccountForm').addEventListener('submit', async (e) => {
            e.preventDefault(); // ÈòªÊ≠¢Ë°®ÂçïÈªòËÆ§Êèê‰∫§Ë°å‰∏∫

            const formData = {
                username: document.getElementById('createUsername').value,
                role: document.getElementById('createRole').value,
                employee_name: document.getElementById('createEmployeeName').value,
                store_address: document.getElementById('createStoreAddress').value,
                phone_number: document.getElementById('createPhoneNumber').value, // Ê∑ªÂä†ÊâãÊú∫Âè∑
                email: document.getElementById('createEmail').value, // Ê∑ªÂä†ÈÇÆÁÆ±
                password: document.getElementById('createPassword').value,
            };

            try {
                const response = await fetch('/create_account', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData),
                });

                if (response.ok) {
                    alert('Account created successfully! Please wait for authorization.');
                    document.getElementById('createAccountForm').reset(); // Ê∏ÖÁ©∫Ë°®Âçï
                    fetchAccounts(); // Ë∞ÉÁî®Êõ¥Êñ∞Ë¥¶Êà∑Ë°®ÁöÑÂáΩÊï∞
                    fetchPendingAccounts();
                } else {
                    const errorData = await response.json();
                    alert('Error: ' + errorData.message);
                }
            } catch (error) {
                alert('An error occurred while creating the account.');
            }
        });


        // Show Setting Account Section
        function showSettingAccountForm() {
            document.getElementById('settingAccountForm').classList.remove('d-none');
            document.getElementById('accountManagementSection').classList.add('d-none');
            document.getElementById('editCategoryForm').classList.add('d-none');
            document.getElementById('addItemForm').classList.add('d-none');

        }

        // Show Account Management Section
        function showAccountManagement() {
            document.getElementById('addItemForm').classList.add('d-none');
            document.getElementById('editCategoryForm').classList.add('d-none');
            document.getElementById('accountManagementSection').classList.remove('d-none');
            document.getElementById('settingAccountForm').classList.add('d-none');


        }

        // Toggle forms
        function showAddItemForm() {
            document.getElementById('addItemForm').classList.remove('d-none');
            document.getElementById('editCategoryForm').classList.add('d-none');
            document.getElementById('accountManagementSection').classList.add('d-none');
            document.getElementById('settingAccountForm').classList.add('d-none');


        }

        function showEditCategoryForm() {
            document.getElementById('editCategoryForm').classList.remove('d-none');
            document.getElementById('addItemForm').classList.add('d-none');
            document.getElementById('accountManagementSection').classList.add('d-none');
            document.getElementById('settingAccountForm').classList.add('d-none');

        }


        document.addEventListener('DOMContentLoaded', () => {
            const addItemForm = document.getElementById('addItemFormContent');
            if (addItemForm) {
                addItemForm.addEventListener('submit', async (e) => {
                    e.preventDefault(); // Prevent default form submission

                    // Handle form submission
                    const formData = new FormData(addItemForm);

                    try {
                        const response = await fetch('/owner_dashboard', {
                            method: 'POST',
                            body: formData,
                        });

                        if (response.ok) {
                            alert('Item saved successfully!');
                            window.location.reload(); // Refresh the page
                        } else {
                            alert('Failed to save item.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('An error occurred while saving the item.');
                    }
                });
            } else {
                console.error('Add Item form not found!');
            }
        });

        // Fetch and display stock warnings
        async function fetchStockWarnings() {
            const response = await fetch('/items');
            const items = await response.json();

            // ÂàÜÁªÑ‰ΩéÂ∫ìÂ≠òÂïÜÂìÅ
            const categoryWarnings = {};
            items.forEach(item => {
                if (item.in_stock_level <= item.reorder_level) {
                    if (!categoryWarnings[item.category]) {
                        categoryWarnings[item.category] = [];
                    }
                    categoryWarnings[item.category].push(item);
                }
            });

            // Ëé∑Âèñ HTML ÂÖÉÁ¥†
            const warningContainer = document.getElementById('stockWarnings');
            const warningList = document.getElementById('warningList');

            // Ê∏ÖÁ©∫ÊóßÊï∞ÊçÆ
            warningList.innerHTML = '';

            // **Â¶ÇÊûúÊ≤°ÊúâË≠¶ÂëäÔºåÊòæÁ§∫‚ÄúÊ≤°ÊúâWarnings‚Äù**
            if (Object.keys(categoryWarnings).length === 0) {
                warningContainer.classList.remove('d-none'); // Á°Æ‰øùÊòæÁ§∫
                warningList.innerHTML = `
                    <div class="text-success fw-bold">‚úÖ No stock warnings. All items are sufficiently stocked.</div>
                `;
                return;
            }

            // **Âê¶ÂàôÔºåÊ≠£Â∏∏ÊòæÁ§∫Ë≠¶Âëä**
            warningContainer.classList.remove('d-none'); // Á°Æ‰øùÊòæÁ§∫

            Object.keys(categoryWarnings).forEach(category => {
                const details = document.createElement('details');
                details.classList.add('mb-2');

                // ÊòæÁ§∫Á±ªÂà´ÂêçÁß∞
                const summary = document.createElement('summary');
                summary.textContent = `‚ö†Ô∏è Category: ${category} - ${categoryWarnings[category].length} items below reorder level`;
                summary.style.cursor = 'pointer';
                summary.classList.add('fw-bold', 'text-danger');

                // ÂàóÂá∫‰ΩéÂ∫ìÂ≠òÂïÜÂìÅ
                const itemList = document.createElement('ul');
                itemList.classList.add('list-group', 'ms-3', 'mt-2');

                categoryWarnings[category].forEach(item => {
                    const restockQuantity = item.max_stock_level - item.in_stock_level;
                    const listItem = document.createElement('li');
                    listItem.classList.add('list-group-item', 'small');
                    listItem.innerHTML = `
                        <strong>${item.name}</strong> - Current: ${item.in_stock_level}, Reorder: ${item.reorder_level},
                        <span class="text-primary">Restock: ${restockQuantity}</span>
                    `;
                    itemList.appendChild(listItem);
                });

                // ÁªÑÂêà HTML ÁªìÊûÑ
                details.appendChild(summary);
                details.appendChild(itemList);
                warningList.appendChild(details);
            });
        }

        // È°µÈù¢Âä†ËΩΩÊó∂Ë∞ÉÁî®
        document.addEventListener('DOMContentLoaded', fetchStockWarnings);

        // Optionally, fetch warnings periodically (e.g., every 5 minutes)
        setInterval(fetchStockWarnings, 300000); // 300000 ms = 5 minutes

        // Ëß¶ÂèëÂêéÁ´ØÁîüÊàê PDF Âπ∂‰∏ãËΩΩ
        async function downloadStockReport() {
            try {
                const response = await fetch('/download_stock_report');
                if (!response.ok) throw new Error('Failed to download report.');

                // Ëé∑Âèñ Blob Êï∞ÊçÆ
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);

                // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Stock_Warnings_Report.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // ÈáäÊîæ URL ÂØπË±°
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error downloading report: ' + error.message);
            }
        }


        // Function to fetch and update the stock table
        async function updateStockTable() {
            const response = await fetch('/items');
            const items = await response.json();

            // Update the table dynamically (example for employee_dashboard)
            const tableBody = document.getElementById('auditTableBody'); // Change this ID for other dashboards
            tableBody.innerHTML = ''; // Clear previous rows

            items.forEach(item => {
                const row = `
                    <tr>
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>${item.category}</td>
                        <td>${item.in_stock_level}</td>
                        <td>${item.supplier || 'N/A'}</td>
                        <td>
                            ${item.picture ? `<img src="${item.picture}" alt="${item.name}" style="width: 50px; height: 50px;">` : 'No Picture'}
                        </td>
                        <td>
                            <input type="number" id="correctedStock_${item.id}" class="form-control form-control-sm"
                                   value="${item.in_stock_level}" min="0">
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="updateStock(${item.id})">Update</button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        // Fetch and update the table periodically (e.g., every 1 minute)
        setInterval(updateStockTable, 60000); // 60000 ms = 1 minute

        // Fetch and update the table when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            updateStockTable();
        });

        // Ëé∑ÂèñÂπ∂ÊåâÁî®Êà∑ÂàÜÁªÑÊòæÁ§∫Â∫ìÂ≠òÊõ¥Êñ∞ÂéÜÂè≤
        async function fetchUpdateHistory() {
            const response = await fetch('/stock_update_history'); // ‰ªéÂêéÁ´ØËé∑ÂèñÂéÜÂè≤ËÆ∞ÂΩï
            const history = await response.json();

            // Ëé∑Âèñ HTML ÂÆπÂô®
            const historyList = document.getElementById('updateHistoryList');

            // Ê∏ÖÁ©∫ÊóßÊï∞ÊçÆ
            historyList.innerHTML = '';

            // ÈÅçÂéÜÊØè‰∏™Áî®Êà∑ÔºåÁîüÊàêÂéÜÂè≤ËÆ∞ÂΩï
            history.forEach(userData => {
                const userId = `user_${userData.username.replace(/\s+/g, '_')}`;

                // ÂàõÂª∫ `details` ÂèØÂ±ïÂºÄ
                const details = document.createElement('details');
                details.classList.add('mb-2');

                // `summary` ÊòæÁ§∫Áî®Êà∑‰ø°ÊÅØ + Âà†Èô§ÊåâÈíÆ
                const summary = document.createElement('summary');
                summary.innerHTML = `
                    üë§ <strong>${userData.username}</strong> | Category: <strong>${userData.category || 'N/A'}</strong> |
                    Last Update: <strong>${userData.records[0].updated_at}</strong>
                    <button class="btn btn-danger btn-sm ms-2" onclick="deleteStockHistory('${userData.records[0].id}')">Delete</button>
                `;
                summary.style.cursor = 'pointer';
                summary.classList.add('fw-bold', 'text-primary');

                // `table` Â≠òÊîæËØ•Áî®Êà∑ÁöÑËØ¶ÁªÜÊìç‰ΩúËÆ∞ÂΩï
                const table = document.createElement('table');
                table.classList.add('table', 'table-striped', 'table-bordered', 'ms-3', 'mt-2');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Stock Before</th>
                            <th>Stock After</th>
                            <th>Updated At</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="${userId}_table"></tbody>
                `;

                // Â°´ÂÖÖË°®Ê†ºÊï∞ÊçÆ
                const tableBody = table.querySelector('tbody');
                userData.records.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.item_name}</td>
                        <td>${record.stock_before}</td>
                        <td>${record.stock_after}</td>
                        <td>${record.updated_at}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteStockHistory('${record.id}')">Delete</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                // Âú® summary ÈÉ®ÂàÜÊ∑ªÂä†Âà†Èô§Áî®Êà∑ÊâÄÊúâËÆ∞ÂΩïÁöÑÊåâÈíÆ
                summary.innerHTML = `
                    üë§ <strong>${userData.username}</strong> | Category: <strong>${userData.category || 'N/A'}</strong> |
                    Last Update: <strong>${userData.records[0].updated_at}</strong>
                    <button class="btn btn-danger btn-sm ms-2" onclick="deleteUserStockHistory('${userData.username}')">Delete All</button>
                `;

                // ÁªÑÂêà HTML ÁªìÊûÑ
                details.appendChild(summary);
                details.appendChild(table);
                historyList.appendChild(details);
            });
        }

        // ‰øÆÊîπÂà†Èô§ÊåâÈíÆÁöÑÈÄªËæë
        function deleteUserStockHistory(username) {
            if (confirm(`Are you sure you want to delete all stock updates for user ${username}?`)) {
                fetch(`/delete_user_stock_updates/${username}`, {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                        fetchUpdateHistory(); // ÈáçÊñ∞Ëé∑ÂèñÊõ¥Êñ∞ÂéÜÂè≤
                    }
                })
                .catch(error => {
                    alert('An error occurred while deleting the stock updates.');
                    console.error(error);
                });
            }
        }

        // **Âà†Èô§Â∫ìÂ≠òÊõ¥Êñ∞ËÆ∞ÂΩï**
        async function deleteStockHistory(recordId) {
            if (!recordId || recordId === 'undefined') {
                alert('Invalid record ID!');
                return;
            }

            if (!confirm('Are you sure you want to delete this stock update record?')) {
                return;
            }

            try {
                const response = await fetch(`/delete_stock_update/${recordId}`, {method: 'DELETE'});
                if (response.ok) {
                    alert('Stock update record deleted successfully!');
                    fetchUpdateHistory(); // ÈáçÊñ∞Ëé∑ÂèñÊõ¥Êñ∞ÂéÜÂè≤
                } else {
                    alert('Failed to delete stock update record.');
                }
            } catch (error) {
                alert('An error occurred while deleting the stock update record.');
            }
        }


        // È°µÈù¢Âä†ËΩΩÊó∂Ë∞ÉÁî®
        document.addEventListener('DOMContentLoaded', fetchUpdateHistory);


        // Optionally, fetch update history periodically (e.g., every 5 minutes)
        setInterval(fetchUpdateHistory, 300000); // 300000 ms = 5 minutes

        // ÂàùÂßãÂåñÊó∂Âä†ËΩΩÂæÖÊéàÊùÉÂàóË°®
        document.addEventListener('DOMContentLoaded', () => {
            fetchPendingAccounts();
            // ÂÖ∂‰ªñÂàùÂßãÂåñÂáΩÊï∞
            fetchItems();
            fetchCategories();
            fetchAccounts();
        });
</script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
